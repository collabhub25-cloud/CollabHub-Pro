<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network - CollabHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7' },
                        secondary: { 500: '#d946ef', 600: '#c026d3' },
                        accent: { 500: '#10b981' }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen font-sans">
    <!-- Navigation -->
    <nav class="fixed w-full z-50 bg-slate-900/80 backdrop-blur-xl border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <a href="../index.html" class="flex items-center space-x-2">
                    <div
                        class="w-10 h-10 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-xl flex items-center justify-center">
                        <span class="text-white font-bold text-xl">C</span>
                    </div>
                    <span class="text-white font-bold text-xl">CollabHub</span>
                </a>

                <!-- Unauthenticated Navigation -->
                <div id="unauthenticated-nav" class="hidden md:flex items-center space-x-8">
                    <a href="../index.html#features"
                        class="text-gray-300 hover:text-white transition-colors">Features</a>
                    <a href="opportunities.html"
                        class="text-gray-300 hover:text-white transition-colors">Opportunities</a>
                    <a href="../index.html#about" class="text-gray-300 hover:text-white transition-colors">About</a>
                </div>

                <!-- Authenticated Navigation -->
                <div id="authenticated-nav" class="hidden md:flex items-center space-x-8">
                    <a href="../index.html" class="text-gray-300 hover:text-white transition-colors">Home</a>
                    <a href="startups.html" class="text-gray-300 hover:text-white transition-colors">Explore
                        Startups</a>
                    <a href="network.html" class="text-primary-400 hover:text-primary-300 transition-colors">Network</a>
                    <a href="#" id="dashboard-link"
                        class="text-gray-300 hover:text-white transition-colors">Dashboard</a>
                    <a href="messages.html" class="text-gray-300 hover:text-white transition-colors">Messages</a>
                </div>

                <!-- Unauthenticated Actions -->
                <div id="unauthenticated-actions" class="flex items-center space-x-4">
                    <a href="login.html" class="text-gray-300 hover:text-white transition-colors">Sign In</a>
                    <a href="register.html"
                        class="px-4 py-2 bg-gradient-to-r from-primary-500 to-secondary-500 text-white rounded-lg font-medium hover:opacity-90">Get
                        Started</a>
                </div>

                <!-- Authenticated Actions -->
                <div id="authenticated-actions" class="hidden items-center space-x-4">
                    <a href="profile.html" class="text-gray-300 hover:text-white transition-colors">Profile</a>
                    <button id="logout-btn" class="text-red-400 hover:text-red-300 transition-colors">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="pt-24 pb-12 px-4">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-4">Your Network</h1>
                <p class="text-gray-400 text-lg max-w-2xl mx-auto">Connect with founders, developers, and innovators.
                    Build your professional network.</p>
            </div>

            <!-- Tabs -->
            <div class="flex justify-center mb-8">
                <div class="bg-white/5 rounded-xl p-1 inline-flex">
                    <button id="tab-browse"
                        class="tab-btn px-6 py-2 rounded-lg text-white bg-primary-500 transition-all">Browse
                        Users</button>
                    <button id="tab-requests"
                        class="tab-btn px-6 py-2 rounded-lg text-gray-400 hover:text-white transition-all">
                        Requests <span id="request-count"
                            class="ml-1 px-2 py-0.5 bg-red-500 rounded-full text-xs hidden">0</span>
                    </button>
                    <button id="tab-connections"
                        class="tab-btn px-6 py-2 rounded-lg text-gray-400 hover:text-white transition-all">My
                        Connections</button>
                </div>
            </div>

            <!-- Browse Users Tab -->
            <div id="panel-browse" class="tab-panel">
                <!-- Filters -->
                <div class="bg-white/5 backdrop-blur-xl rounded-2xl p-6 border border-white/10 mb-8">
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="relative">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text" id="search-users" placeholder="Search users..."
                                class="w-full pl-10 pr-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary-500">
                        </div>
                        <select id="filter-role"
                            class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary-500">
                            <option value="">All Roles</option>
                            <option value="founder">üöÄ Founders</option>
                            <option value="talent">üí° Talent</option>
                            <option value="investor">üìà Investors</option>
                        </select>
                        <select id="filter-skill"
                            class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary-500">
                            <option value="">All Skills</option>
                            <option value="Python">Python</option>
                            <option value="React">React</option>
                            <option value="Node.js">Node.js</option>
                            <option value="Machine Learning">Machine Learning</option>
                            <option value="UI/UX">UI/UX Design</option>
                        </select>
                    </div>
                </div>

                <!-- Users Grid -->
                <div id="users-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="text-center col-span-full py-12">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-400">Loading users...</p>
                    </div>
                </div>
            </div>

            <!-- Requests Tab -->
            <div id="panel-requests" class="tab-panel hidden">
                <div id="requests-list" class="space-y-4">
                    <div class="text-center py-12">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-400">Loading requests...</p>
                    </div>
                </div>
            </div>

            <!-- Connections Tab -->
            <div id="panel-connections" class="tab-panel hidden">
                <div id="connections-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="text-center col-span-full py-12">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-400">Loading connections...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/security.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/app.js"></script>
    <script>
        // State
        let currentUserId = null;
        let connectionMap = {}; // userId -> {id, status}
        let pendingRequests = [];

        // Check auth
        if (!window.CollabHubAPI.isAuthenticated()) {
            window.location.href = 'login.html';
        }
        const userData = window.CollabHubAPI.getUserData();
        currentUserId = userData?.id;

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('bg-primary-500', 'text-white');
                    b.classList.add('text-gray-400');
                });
                btn.classList.add('bg-primary-500', 'text-white');
                btn.classList.remove('text-gray-400');

                document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
                const panelId = btn.id.replace('tab-', 'panel-');
                document.getElementById(panelId).classList.remove('hidden');
            });
        });

        const roleColors = {
            founder: 'bg-purple-500/20 text-purple-400',
            talent: 'bg-blue-500/20 text-blue-400',
            investor: 'bg-green-500/20 text-green-400',
            student: 'bg-yellow-500/20 text-yellow-400'
        };

        // Create user card - SECURITY HARDENED
        function createUserCard(user) {
            const esc = window.CollabHubSecurity.escapeHTML;
            const connection = connectionMap[user.id];
            const skills = (user.skills || []).slice(0, 3);
            const initials = (user.first_name?.[0] || '') + (user.last_name?.[0] || user.email?.[0] || 'U');

            // Escape all user-provided content
            const safeName = esc((user.first_name || '') + ' ' + (user.last_name || user.email?.split('@')[0] || 'User'));
            const safeInitials = esc(initials.toUpperCase());
            const safeHeadline = esc(user.headline || user.bio || 'No bio yet');
            const safeRole = esc(user.role || 'talent');

            let connectBtn = '';
            if (user.id !== currentUserId) {
                if (connection?.status === 'accepted') {
                    connectBtn = `<span class="px-4 py-2 bg-accent-500/20 text-accent-500 rounded-lg text-sm">‚úì Connected</span>`;
                } else if (connection?.status === 'pending') {
                    connectBtn = `<span class="px-4 py-2 bg-yellow-500/20 text-yellow-400 rounded-lg text-sm">‚è≥ Pending</span>`;
                } else {
                    connectBtn = `<button onclick="sendRequest(${parseInt(user.id)}, this)" class="px-4 py-2 bg-primary-500 text-white rounded-lg text-sm hover:bg-primary-600 transition-all">Connect</button>`;
                }
            }

            return `
                <div class="bg-white/5 backdrop-blur-xl rounded-2xl p-6 border border-white/10 hover:border-primary-500/30 transition-all">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-14 h-14 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-xl flex items-center justify-center text-white font-bold text-lg mr-4">
                                ${safeInitials}
                            </div>
                            <div>
                                <h3 class="text-white font-semibold">${safeName}</h3>
                                <span class="px-2 py-0.5 ${roleColors[user.role] || roleColors.talent} rounded text-xs">${safeRole}</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-gray-400 text-sm mb-4 line-clamp-2">${safeHeadline}</p>
                    ${skills.length > 0 ? `
                        <div class="flex flex-wrap gap-1 mb-4">
                            ${skills.map(s => `<span class="px-2 py-1 bg-white/10 text-gray-300 rounded text-xs">${esc(s.skill?.name || s.name || s)}</span>`).join('')}
                        </div>
                    ` : ''}
                    <div class="flex justify-between items-center">
                        ${connectBtn}
                        <a href="profile.html?id=${parseInt(user.id)}" class="text-primary-400 text-sm hover:text-primary-300">View Profile ‚Üí</a>
                    </div>
                </div>
            `;
        }

        // Send connection request
        async function sendRequest(userId, btn) {
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const { api } = window.CollabHubAPI;
                await api.sendConnectionRequest(userId);
                btn.outerHTML = `<span class="px-4 py-2 bg-yellow-500/20 text-yellow-400 rounded-lg text-sm">‚è≥ Pending</span>`;
                connectionMap[userId] = { status: 'pending' };
                window.AppUtils.showToast('Connection request sent!', 'success');
            } catch (error) {
                btn.disabled = false;
                btn.textContent = 'Connect';
                window.AppUtils.showToast(error.message, 'error');
            }
        }

        // Accept/Decline connection
        async function respondConnection(connectionId, action, btn) {
            const card = btn.closest('.request-card');

            try {
                const { api } = window.CollabHubAPI;
                await api.respondToConnection(connectionId, action);

                card.style.opacity = '0';
                setTimeout(() => {
                    card.remove();
                    updateRequestCount();
                    if (action === 'accept') {
                        loadConnections();
                    }
                }, 300);

                window.AppUtils.showToast(action === 'accept' ? 'Connection accepted!' : 'Request declined', action === 'accept' ? 'success' : 'info');
            } catch (error) {
                window.AppUtils.showToast(error.message, 'error');
            }
        }

        // Load users
        async function loadUsers() {
            const grid = document.getElementById('users-grid');
            const search = document.getElementById('search-users').value;
            const role = document.getElementById('filter-role').value;

            try {
                const { api } = window.CollabHubAPI;

                // Build connection map first
                try {
                    const connections = await api.getConnections();
                    (connections.results || connections || []).forEach(c => {
                        const otherId = c.requester.id === currentUserId ? c.receiver.id : c.requester.id;
                        connectionMap[otherId] = { id: c.id, status: c.status };
                    });
                } catch (e) { console.log('Could not load connections'); }

                // Load users
                const params = {};
                if (search) params.search = search;
                if (role) params.role = role;

                let data;
                try {
                    data = await api.getUsers(params);
                } catch (e) {
                    // Sample data
                    data = {
                        results: [
                            { id: 1, first_name: 'Sarah', last_name: 'Chen', email: 'sarah@example.com', role: 'founder', headline: 'AI/ML Startup Founder', skills: ['Python', 'TensorFlow'] },
                            { id: 2, first_name: 'Mike', last_name: 'Johnson', email: 'mike@example.com', role: 'talent', headline: 'Full Stack Developer', skills: ['React', 'Node.js', 'Python'] },
                            { id: 3, first_name: 'Emily', last_name: 'Davis', email: 'emily@example.com', role: 'talent', headline: 'UI/UX Designer', skills: ['Figma', 'UI/UX', 'CSS'] },
                            { id: 4, first_name: 'Alex', last_name: 'Kumar', email: 'alex@example.com', role: 'founder', headline: 'EdTech Entrepreneur', skills: ['Product', 'Marketing'] },
                            { id: 5, first_name: 'Jessica', last_name: 'Lee', email: 'jess@example.com', role: 'investor', headline: 'Angel Investor | Seed Stage', skills: ['Investment', 'Mentoring'] }
                        ]
                    };
                }

                const users = (data.results || data || []).filter(u => u.id !== currentUserId);

                if (users.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">üîç</div>
                            <h3 class="text-xl font-semibold text-white mb-2">No users found</h3>
                            <p class="text-gray-400">Try adjusting your filters</p>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = users.map(createUserCard).join('');

            } catch (error) {
                console.error('Error loading users:', error);
                grid.innerHTML = '<div class="col-span-full text-center text-red-400 py-12">Error loading users</div>';
            }
        }

        // Load connection requests
        async function loadRequests() {
            const list = document.getElementById('requests-list');

            try {
                const { api } = window.CollabHubAPI;
                let requests;
                try {
                    const data = await api.getConnectionRequests();
                    requests = data.results || data || [];
                } catch (e) {
                    requests = [];
                }

                pendingRequests = requests;
                updateRequestCount();

                if (requests.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-12 bg-white/5 rounded-2xl border border-white/10">
                            <div class="text-5xl mb-4">üì≠</div>
                            <h3 class="text-xl font-semibold text-white mb-2">No pending requests</h3>
                            <p class="text-gray-400">When someone wants to connect, you'll see it here</p>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = requests.map(req => {
                    const user = req.requester;
                    const initials = (user.first_name?.[0] || '') + (user.last_name?.[0] || 'U');
                    const date = new Date(req.created_at).toLocaleDateString();

                    return `
                        <div class="request-card bg-white/5 backdrop-blur-xl rounded-2xl p-6 border border-white/10 transition-all" style="transition: opacity 0.3s">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-14 h-14 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-xl flex items-center justify-center text-white font-bold mr-4">
                                        ${initials.toUpperCase()}
                                    </div>
                                    <div>
                                        <h3 class="text-white font-semibold">${user.first_name || ''} ${user.last_name || user.email?.split('@')[0]}</h3>
                                        <p class="text-gray-400 text-sm">${user.headline || user.role || 'CollabHub User'}</p>
                                        <p class="text-gray-500 text-xs mt-1">Sent ${date}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="respondConnection(${req.id}, 'accept', this)" 
                                            class="px-4 py-2 bg-accent-500 text-white rounded-lg text-sm hover:bg-accent-500/80">Accept</button>
                                    <button onclick="respondConnection(${req.id}, 'decline', this)" 
                                            class="px-4 py-2 bg-white/10 text-gray-300 rounded-lg text-sm hover:bg-white/20">Decline</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading requests:', error);
                list.innerHTML = '<div class="text-center text-red-400 py-12">Error loading requests</div>';
            }
        }

        // Load accepted connections
        async function loadConnections() {
            const list = document.getElementById('connections-list');

            try {
                const { api } = window.CollabHubAPI;
                let connections;
                try {
                    const data = await api.getConnections();
                    connections = (data.results || data || []).filter(c => c.status === 'accepted');
                } catch (e) {
                    connections = [];
                }

                if (connections.length === 0) {
                    list.innerHTML = `
                        <div class="col-span-full text-center py-12 bg-white/5 rounded-2xl border border-white/10">
                            <div class="text-5xl mb-4">ü§ù</div>
                            <h3 class="text-xl font-semibold text-white mb-2">No connections yet</h3>
                            <p class="text-gray-400 mb-4">Start building your network by connecting with others</p>
                            <button onclick="document.getElementById('tab-browse').click()" class="px-4 py-2 bg-primary-500 text-white rounded-lg text-sm">Browse Users</button>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = connections.map(conn => {
                    const other = conn.requester.id === currentUserId ? conn.receiver : conn.requester;
                    const initials = (other.first_name?.[0] || '') + (other.last_name?.[0] || 'U');
                    const connectedDate = new Date(conn.updated_at || conn.created_at).toLocaleDateString();

                    return `
                        <div class="bg-white/5 backdrop-blur-xl rounded-2xl p-6 border border-white/10">
                            <div class="flex items-center mb-4">
                                <div class="w-14 h-14 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-xl flex items-center justify-center text-white font-bold mr-4">
                                    ${initials.toUpperCase()}
                                </div>
                                <div>
                                    <h3 class="text-white font-semibold">${other.first_name || ''} ${other.last_name || other.email?.split('@')[0]}</h3>
                                    <span class="px-2 py-0.5 ${roleColors[other.role] || roleColors.talent} rounded text-xs">${other.role || 'talent'}</span>
                                </div>
                            </div>
                            <p class="text-gray-500 text-xs mb-4">Connected since ${connectedDate}</p>
                            <div class="flex space-x-2">
                                <a href="messages.html?user=${other.id}" class="flex-1 py-2 text-center bg-primary-500 text-white rounded-lg text-sm hover:bg-primary-600">Message</a>
                                <a href="profile.html?id=${other.id}" class="flex-1 py-2 text-center bg-white/10 text-gray-300 rounded-lg text-sm hover:bg-white/20">View Profile</a>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading connections:', error);
                list.innerHTML = '<div class="col-span-full text-center text-red-400 py-12">Error loading connections</div>';
            }
        }

        // Update request count badge
        function updateRequestCount() {
            const badge = document.getElementById('request-count');
            const count = pendingRequests.length;
            badge.textContent = count;
            badge.classList.toggle('hidden', count === 0);
        }

        // Debounce
        function debounce(func, wait) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        // Event listeners
        document.getElementById('search-users').addEventListener('input', debounce(loadUsers, 300));
        document.getElementById('filter-role').addEventListener('change', loadUsers);
        document.getElementById('filter-skill').addEventListener('change', loadUsers);

        // Initialize
        loadUsers();
        loadRequests();
        loadConnections();
    </script>
</body>

</html>